# 校园二手交易平台详细设计文档

## 1. 引言

### 1.1 文档目的
本文档旨在详细描述校园二手交易平台的具体实现细节，包括前端组件设计、后端类设计、数据库表结构、API接口实现等内容，为开发人员提供具体的开发指导。

### 1.2 文档范围
本文档涵盖校园二手交易平台的前端详细设计、后端详细设计、数据库详细设计、接口详细实现等方面。

### 1.3 术语定义
- **Vue组件**：Vue.js的基本构建块，用于构建用户界面
- **Spring Boot Controller**：处理HTTP请求和响应的类
- **MyBatis Mapper**：数据库操作的映射接口
- **RESTful API**：基于REST架构风格的API设计

## 2. 前端详细设计

### 2.1 项目结构

```
src/
├── api/              # API接口定义
│   └── index.js      # 所有API接口的统一管理
├── assets/           # 静态资源
│   ├── css/          # 样式文件
│   └── images/       # 图片资源
├── components/       # 通用组件
│   ├── NavBar.vue    # 导航栏组件
│   ├── Footer.vue    # 页脚组件
│   ├── GoodsCard.vue # 商品卡片组件
│   └── Pagination.vue# 分页组件
├── router/           # 路由配置
│   └── index.js      # 路由定义
├── store/            # 状态管理
│   └── index.js      # Vuex配置
├── utils/            # 工具函数
│   ├── request.js    # Axios封装
│   └── date.js       # 日期处理
├── views/            # 页面组件
│   ├── Home.vue      # 首页
│   ├── GoodsDetail.vue # 商品详情页
│   ├── Publish.vue   # 发布商品页
│   ├── Personal.vue  # 个人中心页
│   ├── Order.vue     # 订单页
│   ├── Favorite.vue  # 收藏页
│   ├── Login.vue     # 登录页
│   ├── Register.vue  # 注册页
│   └── Admin/        # 后台管理页面
│       ├── UserManage.vue   # 用户管理
│       ├── GoodsManage.vue  # 商品管理
│       └── OrderManage.vue  # 订单管理
├── App.vue           # 根组件
└── main.js           # 入口文件
```

### 2.2 路由配置

```javascript
// src/router/index.js
import Vue from 'vue'
import Router from 'vue-router'

Vue.use(Router)

export default new Router({
  mode: 'history',
  routes: [
    {
      path: '/',
      name: 'Home',
      component: () => import('@/views/Home.vue')
    },
    {
      path: '/goods/:id',
      name: 'GoodsDetail',
      component: () => import('@/views/GoodsDetail.vue')
    },
    {
      path: '/publish',
      name: 'Publish',
      component: () => import('@/views/Publish.vue'),
      meta: { requireAuth: true }
    },
    {
      path: '/personal',
      name: 'Personal',
      component: () => import('@/views/Personal.vue'),
      meta: { requireAuth: true }
    },
    {
      path: '/order',
      name: 'Order',
      component: () => import('@/views/Order.vue'),
      meta: { requireAuth: true }
    },
    {
      path: '/favorite',
      name: 'Favorite',
      component: () => import('@/views/Favorite.vue'),
      meta: { requireAuth: true }
    },
    {
      path: '/login',
      name: 'Login',
      component: () => import('@/views/Login.vue')
    },
    {
      path: '/register',
      name: 'Register',
      component: () => import('@/views/Register.vue')
    },
    {
      path: '/admin',
      name: 'Admin',
      component: () => import('@/views/Admin/Admin.vue'),
      meta: { requireAuth: true, requireAdmin: true },
      children: [
        {
          path: 'user',
          name: 'UserManage',
          component: () => import('@/views/Admin/UserManage.vue')
        },
        {
          path: 'goods',
          name: 'GoodsManage',
          component: () => import('@/views/Admin/GoodsManage.vue')
        },
        {
          path: 'order',
          name: 'OrderManage',
          component: () => import('@/views/Admin/OrderManage.vue')
        }
      ]
    }
  ]
})
```

### 2.3 API接口封装

```javascript
// src/api/index.js
import request from '@/utils/request'

export default {
  // 用户管理
  user: {
    login: (params) => request.post('/api/user/login', params),
    register: (params) => request.post('/api/user/register', params),
    getInfo: () => request.get('/api/user/info'),
    update: (params) => request.put('/api/user/update', params),
    updatePassword: (params) => request.put('/api/user/password', params)
  },
  // 商品管理
  goods: {
    publish: (params) => request.post('/api/item/publish', params),
    list: (params) => request.get('/api/item/list', { params }),
    detail: (id) => request.get(`/api/item/${id}`),
    update: (params) => request.put('/api/item/update', params),
    delete: (id) => request.delete(`/api/item/${id}`),
    myPublish: (params) => request.get('/api/item/my', { params })
  },
  // 订单管理
  order: {
    create: (params) => request.post('/api/order/create', params),
    list: (params) => request.get('/api/order/list', { params }),
    pay: (id) => request.put(`/api/order/pay/${id}`),
    confirm: (id) => request.put(`/api/order/confirm/${id}`),
    cancel: (id) => request.put(`/api/order/cancel/${id}`)
  },
  // 地址管理
  address: {
    list: () => request.get('/api/address/list'),
    add: (params) => request.post('/api/address/add', params),
    update: (params) => request.put('/api/address/update', params),
    delete: (id) => request.delete(`/api/address/${id}`),
    setDefault: (id) => request.put(`/api/address/default/${id}`)
  },
  // 收藏管理
  favorite: {
    list: () => request.get('/api/favorite/list'),
    add: (itemId) => request.post(`/api/favorite/add/${itemId}`),
    delete: (itemId) => request.delete(`/api/favorite/delete/${itemId}`),
    check: (itemId) => request.get(`/api/favorite/check/${itemId}`)
  },
  // 消息管理
  message: {
    list: (itemId) => request.get(`/api/message/list/${itemId}`),
    add: (params) => request.post('/api/message/add', params),
    reply: (params) => request.post('/api/message/reply', params)
  },
  // 管理员管理
  admin: {
    login: (params) => request.post('/api/admin/login', params),
    userList: (params) => request.get('/api/admin/user/list', { params }),
    userUpdate: (params) => request.put('/api/admin/user/update', params),
    goodsList: (params) => request.get('/api/admin/goods/list', { params }),
    goodsUpdate: (params) => request.put('/api/admin/goods/update', params),
    orderList: (params) => request.get('/api/admin/order/list', { params })
  }
}
```

### 2.4 核心组件设计

#### 2.4.1 商品卡片组件 (GoodsCard.vue)

```vue
<template>
  <div class="goods-card">
    <router-link :to="'/goods/' + goods.id">
      <div class="goods-image">
        <img :src="goods.images.split(',')[0]" alt="商品图片">
      </div>
      <div class="goods-info">
        <div class="goods-name">{{ goods.itemName }}</div>
        <div class="goods-price">¥{{ goods.price.toFixed(2) }}</div>
        <div class="goods-address">{{ goods.address }}</div>
        <div class="goods-time">{{ formatDate(goods.createTime) }}</div>
      </div>
    </router-link>
  </div>
</template>

<script>
export default {
  name: 'GoodsCard',
  props: {
    goods: {
      type: Object,
      required: true
    }
  },
  methods: {
    formatDate(date) {
      // 日期格式化方法
      const d = new Date(date)
      return d.toLocaleString()
    }
  }
}
</script>

<style scoped>
.goods-card {
  width: 240px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 16px;
  margin: 16px;
  cursor: pointer;
  transition: all 0.3s;
}

.goods-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transform: translateY(-4px);
}

.goods-image {
  width: 100%;
  height: 180px;
  overflow: hidden;
  margin-bottom: 12px;
}

.goods-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.goods-info {
  display: flex;
  flex-direction: column;
}

.goods-name {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 8px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.goods-price {
  font-size: 20px;
  color: #ff6b81;
  font-weight: bold;
  margin-bottom: 8px;
}

.goods-address {
  font-size: 14px;
  color: #666;
  margin-bottom: 4px;
}

.goods-time {
  font-size: 12px;
  color: #999;
}
</style>
```

#### 2.4.2 首页组件 (Home.vue)

```vue
<template>
  <div class="home">
    <NavBar />
    <div class="container">
      <div class="category">
        <el-tabs v-model="activeTab" @tab-click="handleTabClick">
          <el-tab-pane label="全部" name="all"></el-tab-pane>
          <el-tab-pane label="数码" name="1"></el-tab-pane>
          <el-tab-pane label="家电" name="2"></el-tab-pane>
          <el-tab-pane label="户外" name="3"></el-tab-pane>
          <el-tab-pane label="图书" name="4"></el-tab-pane>
          <el-tab-pane label="其他" name="5"></el-tab-pane>
        </el-tabs>
      </div>
      <div class="goods-list">
        <GoodsCard v-for="goods in goodsList" :key="goods.id" :goods="goods" />
      </div>
      <div class="pagination">
        <el-pagination
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
          :current-page="pageInfo.current"
          :page-sizes="[12, 24, 36, 48]"
          :page-size="pageInfo.size"
          layout="total, sizes, prev, pager, next, jumper"
          :total="pageInfo.total"
        ></el-pagination>
      </div>
    </div>
    <Footer />
  </div>
</template>

<script>
import NavBar from '@/components/NavBar.vue'
import Footer from '@/components/Footer.vue'
import GoodsCard from '@/components/GoodsCard.vue'
import $api from '@/api/index.js'

export default {
  name: 'Home',
  components: {
    NavBar,
    Footer,
    GoodsCard
  },
  data() {
    return {
      activeTab: 'all',
      goodsList: [],
      pageInfo: {
        current: 1,
        size: 12,
        total: 0
      }
    }
  },
  created() {
    this.loadGoods()
  },
  methods: {
    loadGoods() {
      const params = {
        page: this.pageInfo.current,
        limit: this.pageInfo.size
      }
      if (this.activeTab !== 'all') {
        params.category = this.activeTab
      }
      $api.goods.list(params).then(res => {
        if (res.code === 200) {
          this.goodsList = res.data.list
          this.pageInfo.total = res.data.total
        }
      })
    },
    handleTabClick() {
      this.pageInfo.current = 1
      this.loadGoods()
    },
    handleSizeChange(size) {
      this.pageInfo.size = size
      this.loadGoods()
    },
    handleCurrentChange(current) {
      this.pageInfo.current = current
      this.loadGoods()
    }
  }
}
</script>

<style scoped>
.home {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.container {
  flex: 1;
  padding: 20px;
}

.category {
  margin-bottom: 20px;
}

.goods-list {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
}

.pagination {
  margin-top: 30px;
  text-align: center;
}
</style>
```

## 3. 后端详细设计

### 3.1 项目结构

```
com.shanzhu.st/
├── BackendApplication.java  # 应用入口
├── config/                 # 配置类
│   ├── CorsConfig.java     # 跨域配置
│   ├── MyBatisConfig.java  # MyBatis配置
│   └── SecurityConfig.java # 安全配置
├── controller/             # 控制器层
│   ├── UserController.java
│   ├── IdleItemController.java
│   ├── OrderController.java
│   ├── AddressController.java
│   ├── FavoriteController.java
│   ├── MessageController.java
│   └── AdminController.java
├── service/                # 服务层
│   ├── UserService.java
│   ├── IdleItemService.java
│   ├── OrderService.java
│   ├── AddressService.java
│   ├── FavoriteService.java
│   ├── MessageService.java
│   ├── AdminService.java
│   └── impl/              # 服务实现
│       ├── UserServiceImpl.java
│       ├── IdleItemServiceImpl.java
│       ├── OrderServiceImpl.java
│       ├── AddressServiceImpl.java
│       ├── FavoriteServiceImpl.java
│       ├── MessageServiceImpl.java
│       └── AdminServiceImpl.java
├── mapper/                 # 数据访问层
│   ├── UserMapper.java
│   ├── IdleItemMapper.java
│   ├── OrderMapper.java
│   ├── AddressMapper.java
│   ├── FavoriteMapper.java
│   ├── MessageMapper.java
│   └── AdminMapper.java
├── entity/                 # 实体类
│   ├── User.java
│   ├── IdleItem.java
│   ├── Order.java
│   ├── Address.java
│   ├── Favorite.java
│   ├── Message.java
│   └── Admin.java
├── vo/                     # 视图对象
│   ├── Result.java         # 统一响应对象
│   └── PageResult.java     # 分页响应对象
└── utils/                  # 工具类
    ├── FileUtils.java
    ├── DateUtils.java
    └── EncryptUtils.java
```

### 3.2 实体类设计

#### 3.2.1 User.java

```java
package com.shanzhu.st.entity;

import lombok.Data;
import java.util.Date;

@Data
public class User {
    private Integer userId;
    private String phone;
    private String password;
    private String nickname;
    private String avatar;
    private Date createTime;
    private Integer status;
}
```

#### 3.2.2 IdleItem.java

```java
package com.shanzhu.st.entity;

import lombok.Data;
import java.util.Date;

@Data
public class IdleItem {
    private Integer itemId;
    private Integer userId;
    private String itemName;
    private Double price;
    private String description;
    private String images;
    private Integer category;
    private String address;
    private Date createTime;
    private Integer status;
}
```

#### 3.2.3 Order.java

```java
package com.shanzhu.st.entity;

import lombok.Data;
import java.util.Date;

@Data
public class Order {
    private Integer orderId;
    private String orderNo;
    private Integer userId;
    private Integer itemId;
    private Double price;
    private Integer payStatus;
    private Integer payType;
    private Date createTime;
    private Date payTime;
    private Integer status;
}
```

### 3.3 控制器层设计

#### 3.3.1 UserController.java

```java
package com.shanzhu.st.controller;

import com.shanzhu.st.entity.User;
import com.shanzhu.st.service.UserService;
import com.shanzhu.st.vo.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/user")
public class UserController {

    @Autowired
    private UserService userService;

    @PostMapping("/register")
    public Result register(@RequestBody User user) {
        return userService.register(user);
    }

    @PostMapping("/login")
    public Result login(@RequestBody User user) {
        return userService.login(user);
    }

    @GetMapping("/info")
    public Result getInfo() {
        // 从会话中获取当前用户ID
        Integer userId = (Integer) request.getSession().getAttribute("userId");
        return userService.getInfo(userId);
    }

    @PutMapping("/update")
    public Result update(@RequestBody User user) {
        Integer userId = (Integer) request.getSession().getAttribute("userId");
        user.setUserId(userId);
        return userService.update(user);
    }

    @PutMapping("/password")
    public Result updatePassword(@RequestBody User user) {
        Integer userId = (Integer) request.getSession().getAttribute("userId");
        return userService.updatePassword(userId, user.getPassword());
    }
}
```

#### 3.3.2 IdleItemController.java

```java
package com.shanzhu.st.controller;

import com.shanzhu.st.entity.IdleItem;
import com.shanzhu.st.service.IdleItemService;
import com.shanzhu.st.vo.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

@RestController
@RequestMapping("/api/item")
public class IdleItemController {

    @Autowired
    private IdleItemService idleItemService;

    @PostMapping("/publish")
    public Result publish(@RequestParam("itemName") String itemName,
                         @RequestParam("price") Double price,
                         @RequestParam("description") String description,
                         @RequestParam("category") Integer category,
                         @RequestParam("address") String address,
                         @RequestParam("images") MultipartFile[] images) {
        Integer userId = (Integer) request.getSession().getAttribute("userId");
        return idleItemService.publish(itemName, price, description, category, address, images, userId);
    }

    @GetMapping("/list")
    public Result list(@RequestParam("page") Integer page,
                      @RequestParam("limit") Integer limit,
                      @RequestParam(value = "category", required = false) Integer category) {
        return idleItemService.list(page, limit, category);
    }

    @GetMapping("/{id}")
    public Result detail(@PathVariable("id") Integer id) {
        return idleItemService.detail(id);
    }

    @PutMapping("/update")
    public Result update(@RequestBody IdleItem idleItem) {
        Integer userId = (Integer) request.getSession().getAttribute("userId");
        return idleItemService.update(idleItem, userId);
    }

    @DeleteMapping("/{id}")
    public Result delete(@PathVariable("id") Integer id) {
        Integer userId = (Integer) request.getSession().getAttribute("userId");
        return idleItemService.delete(id, userId);
    }

    @GetMapping("/my")
    public Result myPublish(@RequestParam("page") Integer page,
                           @RequestParam("limit") Integer limit) {
        Integer userId = (Integer) request.getSession().getAttribute("userId");
        return idleItemService.myPublish(page, limit, userId);
    }
}
```

### 3.4 服务层设计

#### 3.4.1 UserService.java

```java
package com.shanzhu.st.service;

import com.shanzhu.st.entity.User;
import com.shanzhu.st.vo.Result;

public interface UserService {
    Result register(User user);
    Result login(User user);
    Result getInfo(Integer userId);
    Result update(User user);
    Result updatePassword(Integer userId, String password);
}
```

#### 3.4.2 UserServiceImpl.java

```java
package com.shanzhu.st.service.impl;

import com.shanzhu.st.entity.User;
import com.shanzhu.st.mapper.UserMapper;
import com.shanzhu.st.service.UserService;
import com.shanzhu.st.utils.EncryptUtils;
import com.shanzhu.st.vo.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class UserServiceImpl implements UserService {

    @Autowired
    private UserMapper userMapper;

    @Override
    public Result register(User user) {
        // 检查手机号是否已注册
        User existingUser = userMapper.findByPhone(user.getPhone());
        if (existingUser != null) {
            return Result.error("手机号已注册");
        }
        // 密码加密
        user.setPassword(EncryptUtils.bcryptEncrypt(user.getPassword()));
        // 设置默认头像
        user.setAvatar("default.jpg");
        // 设置状态为启用
        user.setStatus(1);
        // 注册用户
        int result = userMapper.insert(user);
        if (result > 0) {
            return Result.success("注册成功");
        } else {
            return Result.error("注册失败");
        }
    }

    @Override
    public Result login(User user) {
        // 根据手机号查询用户
        User existingUser = userMapper.findByPhone(user.getPhone());
        if (existingUser == null) {
            return Result.error("手机号或密码错误");
        }
        // 验证密码
        if (!EncryptUtils.bcryptCheck(user.getPassword(), existingUser.getPassword())) {
            return Result.error("手机号或密码错误");
        }
        // 检查用户状态
        if (existingUser.getStatus() == 0) {
            return Result.error("账号已被禁用");
        }
        // 将用户ID存入会话
        request.getSession().setAttribute("userId", existingUser.getUserId());
        // 返回用户信息（不包含密码）
        existingUser.setPassword(null);
        return Result.success("登录成功", existingUser);
    }

    @Override
    public Result getInfo(Integer userId) {
        User user = userMapper.selectByPrimaryKey(userId);
        if (user != null) {
            user.setPassword(null);
            return Result.success("查询成功", user);
        } else {
            return Result.error("用户不存在");
        }
    }

    @Override
    public Result update(User user) {
        int result = userMapper.updateByPrimaryKeySelective(user);
        if (result > 0) {
            return Result.success("更新成功");
        } else {
            return Result.error("更新失败");
        }
    }

    @Override
    public Result updatePassword(Integer userId, String password) {
        // 密码加密
        String encryptedPassword = EncryptUtils.bcryptEncrypt(password);
        int result = userMapper.updatePassword(userId, encryptedPassword);
        if (result > 0) {
            return Result.success("密码更新成功");
        } else {
            return Result.error("密码更新失败");
        }
    }
}
```

### 3.5 数据访问层设计

#### 3.5.1 UserMapper.java

```java
package com.shanzhu.st.mapper;

import com.shanzhu.st.entity.User;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface UserMapper {
    int insert(User user);
    User selectByPrimaryKey(Integer userId);
    User findByPhone(String phone);
    int updateByPrimaryKeySelective(User user);
    int updatePassword(@Param("userId") Integer userId, @Param("password") String password);
}
```

#### 3.5.2 UserMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shanzhu.st.mapper.UserMapper">
    <insert id="insert" parameterType="com.shanzhu.st.entity.User" useGeneratedKeys="true" keyProperty="userId">
        INSERT INTO sh_user (phone, password, nickname, avatar, create_time, status)
        VALUES (#{phone}, #{password}, #{nickname}, #{avatar}, NOW(), #{status})
    </insert>

    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultType="com.shanzhu.st.entity.User">
        SELECT * FROM sh_user WHERE user_id = #{userId}
    </select>

    <select id="findByPhone" parameterType="java.lang.String" resultType="com.shanzhu.st.entity.User">
        SELECT * FROM sh_user WHERE phone = #{phone}
    </select>

    <update id="updateByPrimaryKeySelective" parameterType="com.shanzhu.st.entity.User">
        UPDATE sh_user
        <set>
            <if test="phone != null">phone = #{phone},</if>
            <if test="password != null">password = #{password},</if>
            <if test="nickname != null">nickname = #{nickname},</if>
            <if test="avatar != null">avatar = #{avatar},</if>
            <if test="status != null">status = #{status},</if>
        </set>
        WHERE user_id = #{userId}
    </update>

    <update id="updatePassword">
        UPDATE sh_user SET password = #{password} WHERE user_id = #{userId}
    </update>
</mapper>
```

## 4. 数据库详细设计

### 4.1 数据库表结构

#### 4.1.1 用户表（sh_user）

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| user_id | int | 11 | PRIMARY KEY, AUTO_INCREMENT | 用户ID |
| phone | varchar | 20 | NOT NULL, UNIQUE | 手机号 |
| password | varchar | 100 | NOT NULL | 密码（BCrypt加密） |
| nickname | varchar | 50 | NOT NULL | 昵称 |
| avatar | varchar | 200 | DEFAULT 'default.jpg' | 头像 |
| create_time | datetime | | NOT NULL DEFAULT CURRENT_TIMESTAMP | 注册时间 |
| status | tinyint | 4 | NOT NULL DEFAULT 1 | 用户状态（0：禁用，1：启用） |

#### 4.1.2 商品表（sh_idle_item）

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| item_id | int | 11 | PRIMARY KEY, AUTO_INCREMENT | 商品ID |
| user_id | int | 11 | NOT NULL | 卖家ID |
| item_name | varchar | 100 | NOT NULL | 商品名称 |
| price | decimal | 10,2 | NOT NULL | 商品价格 |
| description | text | | NOT NULL | 商品描述 |
| images | varchar | 500 | NOT NULL | 商品图片（多个图片用逗号分隔） |
| category | tinyint | 4 | NOT NULL | 商品分类（1：数码，2：家电，3：户外，4：图书，5：其他） |
| address | varchar | 200 | NOT NULL | 交易地点 |
| create_time | datetime | | NOT NULL DEFAULT CURRENT_TIMESTAMP | 发布时间 |
| status | tinyint | 4 | NOT NULL DEFAULT 1 | 商品状态（0：下架，1：上架，2：已卖出） |

#### 4.1.3 订单表（sh_order）

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| order_id | int | 11 | PRIMARY KEY, AUTO_INCREMENT | 订单ID |
| order_no | varchar | 32 | NOT NULL, UNIQUE | 订单编号 |
| user_id | int | 11 | NOT NULL | 买家ID |
| item_id | int | 11 | NOT NULL | 商品ID |
| price | decimal | 10,2 | NOT NULL | 订单价格 |
| pay_status | tinyint | 4 | NOT NULL DEFAULT 0 | 支付状态（0：未支付，1：已支付） |
| pay_type | tinyint | 4 | | 支付方式 |
| create_time | datetime | | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| pay_time | datetime | | | 支付时间 |
| status | tinyint | 4 | NOT NULL DEFAULT 0 | 订单状态（0：待支付，1：已支付，2：已完成，3：已取消） |

### 4.2 索引设计

| 表名 | 索引名 | 索引字段 | 索引类型 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| sh_user | idx_phone | phone | UNIQUE | 加速手机号查询 |
| sh_idle_item | idx_user_id | user_id | NORMAL | 加速卖家商品查询 |
| sh_idle_item | idx_category | category | NORMAL | 加速分类查询 |
| sh_idle_item | idx_status | status | NORMAL | 加速状态查询 |
| sh_order | idx_user_id | user_id | NORMAL | 加速用户订单查询 |
| sh_order | idx_item_id | item_id | NORMAL | 加速商品订单查询 |
| sh_order | idx_order_no | order_no | UNIQUE | 加速订单号查询 |
| sh_order | idx_status | status | NORMAL | 加速状态查询 |

### 4.3 存储过程

#### 4.3.1 创建订单存储过程

```sql
DELIMITER //
CREATE PROCEDURE create_order(IN user_id INT, IN item_id INT, OUT order_id INT, OUT order_no VARCHAR(32))
BEGIN
    DECLARE price DECIMAL(10,2);
    DECLARE item_status INT;
    
    -- 检查商品状态
    SELECT status INTO item_status FROM sh_idle_item WHERE item_id = item_id;
    IF item_status != 1 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '商品已下架或已卖出';
    END IF;
    
    -- 获取商品价格
    SELECT price INTO price FROM sh_idle_item WHERE item_id = item_id;
    
    -- 生成订单号
    SET order_no = CONCAT(DATE_FORMAT(NOW(), '%Y%m%d%H%i%s'), LPAD(FLOOR(RAND() * 10000), 4, '0'));
    
    -- 创建订单
    INSERT INTO sh_order (order_no, user_id, item_id, price, pay_status, status) 
    VALUES (order_no, user_id, item_id, price, 0, 0);
    
    -- 获取订单ID
    SET order_id = LAST_INSERT_ID();
    
    -- 更新商品状态为已卖出
    UPDATE sh_idle_item SET status = 2 WHERE item_id = item_id;
END //
DELIMITER ;
```

#### 4.3.2 支付订单存储过程

```sql
DELIMITER //
CREATE PROCEDURE pay_order(IN order_id INT)
BEGIN
    DECLARE order_status INT;
    DECLARE pay_status INT;
    
    -- 检查订单状态
    SELECT status, pay_status INTO order_status, pay_status FROM sh_order WHERE order_id = order_id;
    
    IF order_status = 0 AND pay_status = 0 THEN
        -- 更新支付状态和订单状态
        UPDATE sh_order SET pay_status = 1, pay_time = NOW(), status = 1 WHERE order_id = order_id;
        SELECT '支付成功' AS result;
    ELSE
        SELECT '订单状态错误' AS result;
    END IF;
END //
DELIMITER ;
```

## 5. API接口详细实现

### 5.1 用户管理接口

#### 5.1.1 用户注册

- **URL**：/api/user/register
- **请求方式**：POST
- **请求参数**：
  ```json
  {
    "phone": "13800138000",
    "password": "123456",
    "nickname": "test"
  }
  ```
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "注册成功",
    "data": {
      "userId": 1,
      "phone": "13800138000",
      "nickname": "test",
      "avatar": "default.jpg",
      "createTime": "2023-06-01 10:00:00",
      "status": 1
    }
  }
  ```

#### 5.1.2 用户登录

- **URL**：/api/user/login
- **请求方式**：POST
- **请求参数**：
  ```json
  {
    "phone": "13800138000",
    "password": "123456"
  }
  ```
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "登录成功",
    "data": {
      "userId": 1,
      "phone": "13800138000",
      "nickname": "test",
      "avatar": "default.jpg",
      "createTime": "2023-06-01 10:00:00",
      "status": 1
    }
  }
  ```

### 5.2 商品管理接口

#### 5.2.1 发布商品

- **URL**：/api/item/publish
- **请求方式**：POST
- **请求参数**：FormData格式
  - itemName：商品名称
  - price：商品价格
  - description：商品描述
  - category：商品分类
  - address：交易地点
  - images：商品图片数组
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "发布成功",
    "data": {
      "itemId": 1,
      "itemName": "二手手机",
      "price": 1000.00,
      "images": "image1.jpg,image2.jpg",
      "category": 1,
      "address": "学校南门",
      "createTime": "2023-06-01 10:30:00",
      "status": 1
    }
  }
  ```

#### 5.2.2 获取商品列表

- **URL**：/api/item/list
- **请求方式**：GET
- **请求参数**：
  - page：页码（默认1）
  - limit：每页数量（默认12）
  - category：商品分类（可选）
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "查询成功",
    "data": {
      "total": 100,
      "list": [
        {
          "itemId": 1,
          "itemName": "二手手机",
          "price": 1000.00,
          "images": "image1.jpg,image2.jpg",
          "category": 1,
          "address": "学校南门",
          "createTime": "2023-06-01 10:30:00",
          "status": 1
        }
      ]
    }
  }
  ```

### 5.3 订单管理接口

#### 5.3.1 创建订单

- **URL**：/api/order/create
- **请求方式**：POST
- **请求参数**：
  ```json
  {
    "itemId": 1
  }
  ```
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "订单创建成功",
    "data": {
      "orderId": 1,
      "orderNo": "202306011030001234",
      "price": 1000.00,
      "status": 0
    }
  }
  ```

#### 5.3.2 支付订单

- **URL**：/api/order/pay/1
- **请求方式**：PUT
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "支付成功",
    "data": {
      "orderId": 1,
      "orderNo": "202306011030001234",
      "payStatus": 1,
      "status": 1,
      "payTime": "2023-06-01 10:35:00"
    }
  }
  ```

## 6. 错误处理设计

### 6.1 前端错误处理

```javascript
// src/utils/request.js
import axios from 'axios'

const request = axios.create({
  baseURL: process.env.VUE_APP_BASE_API,
  timeout: 5000,
  withCredentials: true
})

// 请求拦截器
request.interceptors.request.use(
  config => {
    // 配置请求参数
    return config
  },
  error => {
    console.error('请求错误:', error)
    return Promise.reject(error)
  }
)

// 响应拦截器
request.interceptors.response.use(
  response => {
    const res = response.data
    if (res.code !== 200) {
      // 提示错误信息
      ElMessage.error(res.message || '请求失败')
      
      // 处理特定错误码
      if (res.code === 401) {
        // 未登录，跳转到登录页
        router.push('/login')
      } else if (res.code === 403) {
        // 没有权限，跳转到无权限页
        router.push('/403')
      }
      
      return Promise.reject(new Error(res.message || '请求失败'))
    } else {
      return res
    }
  },
  error => {
    console.error('响应错误:', error)
    
    // 处理网络错误
    if (error.message.includes('timeout')) {
      ElMessage.error('请求超时，请稍后重试')
    } else if (error.message.includes('Network Error')) {
      ElMessage.error('网络错误，请检查网络连接')
    } else {
      ElMessage.error('请求失败，请稍后重试')
    }
    
    return Promise.reject(error)
  }
)

export default request
```

### 6.2 后端错误处理

```java
package com.shanzhu.st.config;

import com.shanzhu.st.vo.Result;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;

@ControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(Exception.class)
    @ResponseBody
    public Result handleException(Exception e) {
        e.printStackTrace();
        return Result.error("系统错误，请稍后重试");
    }

    @ExceptionHandler(RuntimeException.class)
    @ResponseBody
    public Result handleRuntimeException(RuntimeException e) {
        e.printStackTrace();
        return Result.error(e.getMessage());
    }

    // 处理特定异常
    @ExceptionHandler(NullPointerException.class)
    @ResponseBody
    public Result handleNullPointerException(NullPointerException e) {
        e.printStackTrace();
        return Result.error("空指针异常");
    }

    @ExceptionHandler(IllegalArgumentException.class)
    @ResponseBody
    public Result handleIllegalArgumentException(IllegalArgumentException e) {
        e.printStackTrace();
        return Result.error(e.getMessage());
    }
}
```

## 7. 总结

本文档详细描述了校园二手交易平台的具体实现细节，包括前端组件设计、后端类设计、数据库表结构、API接口实现等内容。开发人员可以根据本文档的指导进行具体的开发工作。

本文档涵盖了平台的核心功能模块，包括用户管理、商品管理、订单管理等，确保了平台的完整性和可用性。同时，文档也考虑了系统的安全性、性能和可扩展性，为平台的长期发展提供了保障。