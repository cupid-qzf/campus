# 校园二手交易平台部署说明

## 1. 部署环境准备

### 1.1 系统要求
- **操作系统**：Windows Server 2016/2019/2022 或 Linux（Ubuntu 18.04+、CentOS 7+）
- **CPU**：至少 2 核
- **内存**：至少 4 GB RAM
- **存储空间**：至少 50 GB 可用磁盘空间

### 1.2 软件依赖
- **Java JDK**：1.8 或以上版本
- **MySQL**：8.0 或以上版本
- **Node.js**：14.0 或以上版本
- **Maven**：3.6.0 或以上版本（仅后端需要）
- **Nginx**：1.16 或以上版本（可选，用于前端静态资源部署）

## 2. 数据库部署

### 2.1 数据库安装
1. 下载并安装 MySQL 8.0 或以上版本
2. 启动 MySQL 服务
3. 登录 MySQL：
   ```bash
   mysql -u root -p
   ```

### 2.2 数据库创建
1. 创建数据库：
   ```sql
   CREATE DATABASE DB_School_trade CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```

2. 创建数据库用户并授权：
   ```sql
   CREATE USER 'school_trade'@'localhost' IDENTIFIED BY 'your_password';
   GRANT ALL PRIVILEGES ON DB_School_trade.* TO 'school_trade'@'localhost';
   FLUSH PRIVILEGES;
   ```

### 2.3 数据库初始化
1. 导入数据库脚本：
   ```bash
   mysql -u school_trade -p DB_School_trade < c:\Users\28389\Desktop\stb\school-trade-backend\DB_School_Trade.sql
   ```

## 3. 后端部署

### 3.1 项目配置修改
1. 进入后端项目目录：
   ```bash
   cd c:\Users\28389\Desktop\stb\school-trade-backend
   ```

2. 修改 `src/main/resources/application.yml` 配置文件：
   - 数据库连接信息
     ```yaml
     spring:
       datasource:
         url: jdbc:mysql://localhost:3306/DB_School_trade?serverTimezone=UTC&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true
         username: school_trade
         password: your_password
         driver-class-name: com.mysql.cj.jdbc.Driver
     ```
   - 文件上传路径（确保该目录存在且有读写权限）
     ```yaml
     userFilePath: D:\school-trade\pic  # Windows
     # userFilePath: /opt/school-trade/pic  # Linux
     ```
   - 应用基础URL
     ```yaml
     baseUrl: http://your-server-ip:8080
     ```

### 3.2 项目构建
1. 使用 Maven 构建后端项目：
   ```bash
   mvn clean package -DskipTests
   ```

2. 构建成功后，在 `target` 目录下会生成可执行的 JAR 文件：
   ```
   school-trade-backend-1.0.0.jar
   ```

### 3.3 项目启动
1. 直接运行 JAR 文件（开发环境）：
   ```bash
   java -jar school-trade-backend-1.0.0.jar
   ```

2. 作为后台服务运行（生产环境）：
   - Windows：
     ```bash
     start javaw -jar school-trade-backend-1.0.0.jar
     ```
   - Linux：
     ```bash
     nohup java -jar school-trade-backend-1.0.0.jar > school-trade.log 2>&1 &
     ```

3. 验证服务是否启动成功：
   ```bash
   curl http://localhost:8080
   ```
   或在浏览器中访问：`http://localhost:8080`

## 4. 前端部署

### 4.1 项目配置修改
1. 进入前端项目目录：
   ```bash
   cd c:\Users\28389\Desktop\stb\school-trade-frontend
   ```

2. 修改 `vue.config.js` 配置文件中的后端 API 地址：
   ```javascript
   module.exports = {
     // ...
     devServer: {
       proxy: {
         '/api': {
           target: 'http://your-backend-server:8080',  // 后端服务地址
           changeOrigin: true,
           pathRewrite: {
             '^/api': ''
           }
         }
       }
     }
   }
   ```

### 4.2 项目构建
1. 安装依赖：
   ```bash
   npm install
   ```

2. 构建生产环境代码：
   ```bash
   npm run build
   ```

3. 构建成功后，会生成 `dist` 目录，包含所有静态资源文件：
   ```
   dist/
   ├── css/
   ├── img/
   ├── js/
   ├── favicon.ico
   └── index.html
   ```

### 4.3 静态资源部署

#### 4.3.1 使用 Nginx 部署（推荐）
1. 安装 Nginx
2. 配置 Nginx 虚拟主机：
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;

       root /path/to/dist;
       index index.html;

       location / {
           try_files $uri $uri/ /index.html;
       }

       # 代理 API 请求到后端服务
       location /api {
           proxy_pass http://localhost:8080;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```

3. 重启 Nginx 服务：
   ```bash
   # Windows
   nginx -s reload
   
   # Linux
   systemctl restart nginx
   ```

#### 4.3.2 使用 Tomcat 部署
1. 安装 Tomcat
2. 将 `dist` 目录下的所有文件复制到 Tomcat 的 `webapps/ROOT` 目录下
3. 启动 Tomcat 服务

### 4.4 验证前端部署
在浏览器中访问：`http://your-domain.com` 或 `http://your-server-ip:8080`

## 5. 文件存储配置

1. 创建文件上传目录（与 `application.yml` 中的配置一致）：
   ```bash
   # Windows
   mkdir -p D:\school-trade\pic
   
   # Linux
   mkdir -p /opt/school-trade/pic
   chmod 755 /opt/school-trade/pic
   ```

2. 确保应用程序对该目录有读写权限

## 6. 常见问题及解决方案

### 6.1 数据库连接失败
- 检查数据库服务是否启动
- 检查数据库连接信息是否正确（用户名、密码、数据库名）
- 检查防火墙是否允许数据库端口访问

### 6.2 后端服务启动失败
- 检查端口是否被占用：
  ```bash
  # Windows
  netstat -ano | findstr 8080
  
  # Linux
  netstat -tlnp | grep 8080
  ```
- 检查日志文件：
  ```bash
  # 直接运行时查看控制台输出
  # 后台运行时查看日志文件
  cat school-trade.log
  ```

### 6.3 前端访问后端 API 失败
- 检查后端服务是否正常运行
- 检查前端配置的 API 地址是否正确
- 检查跨域配置是否正确

### 6.4 文件上传失败
- 检查文件上传目录是否存在
- 检查应用程序对上传目录的权限
- 检查上传文件大小是否超过配置的限制

## 7. 监控与维护

### 7.1 日志管理
- 后端日志：查看 `school-trade.log` 文件
- Nginx 日志：查看 `/var/log/nginx/access.log` 和 `/var/log/nginx/error.log`（Linux）

### 7.2 数据库备份
- 定期备份数据库：
  ```bash
  mysqldump -u school_trade -p DB_School_trade > school_trade_backup_$(date +%Y%m%d).sql
  ```

### 7.3 文件备份
- 定期备份文件上传目录：
  ```bash
  # Windows
  xcopy D:\school-trade\pic D:\school-trade\pic_backup_$(date +%Y%m%d) /E
  
  # Linux
  cp -r /opt/school-trade/pic /opt/school-trade/pic_backup_$(date +%Y%m%d)
  ```

## 8. 安全建议

1. 定期更新操作系统和软件补丁
2. 配置防火墙，仅开放必要的端口（如 80、443、8080）
3. 使用 HTTPS 加密传输（配置 SSL 证书）
4. 定期更改数据库密码和管理密码
5. 限制数据库用户的权限范围
6. 配置文件上传的类型和大小限制
7. 开启数据库的慢查询日志，优化查询性能

## 9. 技术支持

如果在部署过程中遇到问题，请联系技术支持团队：
- 邮箱：support@school-trade.com
- 电话：400-123-4567
- 文档：https://docs.school-trade.com
