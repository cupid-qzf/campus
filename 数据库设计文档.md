# 校园二手交易平台数据库设计文档

## 1. 引言

### 1.1 文档目的
本文档旨在详细描述校园二手交易平台的数据库设计，包括数据库结构、表设计、索引设计、存储过程和触发器等内容，为数据库开发和维护提供指导。

### 1.2 文档范围
本文档涵盖校园二手交易平台的数据库设计，包括用户管理、商品管理、订单管理、地址管理、收藏管理和消息管理等模块的数据库设计。

### 1.3 术语定义
- **ERD**：实体关系图（Entity Relationship Diagram）
- **PK**：主键（Primary Key）
- **FK**：外键（Foreign Key）
- **UK**：唯一键（Unique Key）
- **NOT NULL**：非空约束
- **DEFAULT**：默认值约束
- **AUTO_INCREMENT**：自增约束

## 2. 数据库设计概述

### 2.1 设计原则
- **数据完整性**：确保数据的准确性和一致性
- **数据安全性**：保护数据不被非法访问和修改
- **性能优化**：提高数据库查询和操作效率
- **可扩展性**：便于未来功能扩展和数据量增长
- **易用性**：便于开发人员使用和维护

### 2.2 命名规范
- **数据库名**：使用小写字母，采用下划线分隔单词，如 `school_trade`
- **表名**：使用小写字母，采用下划线分隔单词，前缀为 `sh_`，如 `sh_user`
- **字段名**：使用小写字母，采用下划线分隔单词，如 `user_id`
- **索引名**：使用小写字母，采用下划线分隔单词，前缀为 `idx_`，如 `idx_user_phone`
- **存储过程名**：使用小写字母，采用下划线分隔单词，前缀为 `proc_`，如 `proc_create_order`
- **触发器名**：使用小写字母，采用下划线分隔单词，前缀为 `trg_`，如 `trg_order_update`

### 2.3 数据库环境
- **数据库类型**：MySQL 8.0
- **字符集**：UTF-8mb4
- **排序规则**：utf8mb4_unicode_ci
- **存储引擎**：InnoDB

## 3. 实体关系图（ERD）

```
+----------------+      +----------------+      +----------------+      +----------------+      +----------------+      +----------------+
|     sh_user    |      |  sh_idle_item  |      |     sh_order   |      |  sh_address    |      |  sh_favorite   |      |  sh_message    |
+----------------+      +----------------+      +----------------+      +----------------+      +----------------+      +----------------+
| user_id (PK)   |<-----| item_id (PK)   |<-----| order_id (PK)  |      | address_id (PK)|      | favorite_id (PK)|<-----| message_id (PK)|
| phone          |      | user_id (FK)   |      | user_id (FK)   |      | user_id (FK)   |      | user_id (FK)   |      | user_id (FK)   |
| password       |      | item_name      |      | item_id (FK)   |      | province       |      | item_id (FK)   |      | item_id (FK)   |
| nickname       |      | price          |      | order_no       |      | city           |      | create_time    |      | content        |
| avatar         |      | description    |      | price          |      | district       |      |                |      | reply_id       |
| create_time    |      | images         |      | pay_status     |      | detail_address |      |                |      | create_time    |
| status         |      | category       |      | pay_type       |      | is_default     |      |                |      | status         |
+----------------+      | address        |      | create_time    |      | create_time    |      |                |      |                |
                        | create_time    |      | pay_time       |      |                |      |                |      |                |
                        | status         |      | status         |      |                |      |                |      |                |
                        +----------------+      +----------------+      +----------------+      +----------------+      +----------------+

+----------------+      +----------------+
|    sh_admin    |      | sh_order_address|
+----------------+      +----------------+
| admin_id (PK)  |      | order_id (PK)  |
| username       |      | province       |
| password       |      | city           |
| nickname       |      | district       |
| avatar         |      | detail_address |
| create_time    |      |                |
| status         |      |                |
+----------------+      +----------------+
```

## 4. 数据库表结构

### 4.1 用户表（sh_user）

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| user_id | int | 11 | PRIMARY KEY, AUTO_INCREMENT | | 用户ID |
| phone | varchar | 20 | NOT NULL, UNIQUE | | 手机号 |
| password | varchar | 100 | NOT NULL | | 密码（BCrypt加密） |
| nickname | varchar | 50 | NOT NULL | | 昵称 |
| avatar | varchar | 200 | DEFAULT 'default.jpg' | | 头像 |
| create_time | datetime | | NOT NULL | CURRENT_TIMESTAMP | 注册时间 |
| status | tinyint | 4 | NOT NULL | 1 | 用户状态（0：禁用，1：启用） |

### 4.2 闲置物品表（sh_idle_item）

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| item_id | int | 11 | PRIMARY KEY, AUTO_INCREMENT | | 商品ID |
| user_id | int | 11 | NOT NULL, FOREIGN KEY (sh_user.user_id) | | 卖家ID |
| item_name | varchar | 100 | NOT NULL | | 商品名称 |
| price | decimal | 10,2 | NOT NULL | | 商品价格 |
| description | text | | NOT NULL | | 商品描述 |
| images | varchar | 500 | NOT NULL | | 商品图片（多个图片用逗号分隔） |
| category | tinyint | 4 | NOT NULL | | 商品分类（1：数码，2：家电，3：户外，4：图书，5：其他） |
| address | varchar | 200 | NOT NULL | | 交易地点 |
| create_time | datetime | | NOT NULL | CURRENT_TIMESTAMP | 发布时间 |
| status | tinyint | 4 | NOT NULL | 1 | 商品状态（0：下架，1：上架，2：已卖出） |

### 4.3 订单表（sh_order）

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| order_id | int | 11 | PRIMARY KEY, AUTO_INCREMENT | | 订单ID |
| order_no | varchar | 32 | NOT NULL, UNIQUE | | 订单编号 |
| user_id | int | 11 | NOT NULL, FOREIGN KEY (sh_user.user_id) | | 买家ID |
| item_id | int | 11 | NOT NULL, FOREIGN KEY (sh_idle_item.item_id) | | 商品ID |
| price | decimal | 10,2 | NOT NULL | | 订单价格 |
| pay_status | tinyint | 4 | NOT NULL | 0 | 支付状态（0：未支付，1：已支付） |
| pay_type | tinyint | 4 | | | 支付方式 |
| create_time | datetime | | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| pay_time | datetime | | | | 支付时间 |
| status | tinyint | 4 | NOT NULL | 0 | 订单状态（0：待支付，1：已支付，2：已完成，3：已取消） |

### 4.4 地址表（sh_address）

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| address_id | int | 11 | PRIMARY KEY, AUTO_INCREMENT | | 地址ID |
| user_id | int | 11 | NOT NULL, FOREIGN KEY (sh_user.user_id) | | 用户ID |
| province | varchar | 50 | NOT NULL | | 省份 |
| city | varchar | 50 | NOT NULL | | 城市 |
| district | varchar | 50 | NOT NULL | | 区县 |
| detail_address | varchar | 200 | NOT NULL | | 详细地址 |
| is_default | tinyint | 4 | NOT NULL | 0 | 是否默认地址（0：否，1：是） |
| create_time | datetime | | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

### 4.5 收藏表（sh_favorite）

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| favorite_id | int | 11 | PRIMARY KEY, AUTO_INCREMENT | | 收藏ID |
| user_id | int | 11 | NOT NULL, FOREIGN KEY (sh_user.user_id) | | 用户ID |
| item_id | int | 11 | NOT NULL, FOREIGN KEY (sh_idle_item.item_id) | | 商品ID |
| create_time | datetime | | NOT NULL | CURRENT_TIMESTAMP | 收藏时间 |
| UNIQUE KEY | (user_id, item_id) | | | | 唯一约束，防止重复收藏 |

### 4.6 留言表（sh_message）

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| message_id | int | 11 | PRIMARY KEY, AUTO_INCREMENT | | 留言ID |
| user_id | int | 11 | NOT NULL, FOREIGN KEY (sh_user.user_id) | | 用户ID |
| item_id | int | 11 | NOT NULL, FOREIGN KEY (sh_idle_item.item_id) | | 商品ID |
| content | text | | NOT NULL | | 留言内容 |
| reply_id | int | 11 | FOREIGN KEY (sh_message.message_id) | | 回复的留言ID |
| create_time | datetime | | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| status | tinyint | 4 | NOT NULL | 1 | 状态（0：删除，1：正常） |

### 4.7 管理员表（sh_admin）

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| admin_id | int | 11 | PRIMARY KEY, AUTO_INCREMENT | | 管理员ID |
| username | varchar | 50 | NOT NULL, UNIQUE | | 用户名 |
| password | varchar | 100 | NOT NULL | | 密码（BCrypt加密） |
| nickname | varchar | 50 | NOT NULL | | 昵称 |
| avatar | varchar | 200 | DEFAULT 'admin_default.jpg' | | 头像 |
| create_time | datetime | | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| status | tinyint | 4 | NOT NULL | 1 | 状态（0：禁用，1：启用） |

### 4.8 订单地址表（sh_order_address）

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| order_id | int | 11 | PRIMARY KEY, FOREIGN KEY (sh_order.order_id) | | 订单ID |
| province | varchar | 50 | NOT NULL | | 省份 |
| city | varchar | 50 | NOT NULL | | 城市 |
| district | varchar | 50 | NOT NULL | | 区县 |
| detail_address | varchar | 200 | NOT NULL | | 详细地址 |

## 4. 索引设计

### 4.1 用户表（sh_user）

| 索引名 | 索引字段 | 索引类型 | 描述 |
| :--- | :--- | :--- | :--- |
| PRIMARY | user_id | 主键索引 | 唯一标识用户记录 |
| idx_phone | phone | 唯一索引 | 加速手机号查询，确保手机号唯一 |
| idx_status | status | 普通索引 | 加速用户状态查询 |

### 4.2 闲置物品表（sh_idle_item）

| 索引名 | 索引字段 | 索引类型 | 描述 |
| :--- | :--- | :--- | :--- |
| PRIMARY | item_id | 主键索引 | 唯一标识商品记录 |
| idx_user_id | user_id | 普通索引 | 加速卖家商品查询 |
| idx_category | category | 普通索引 | 加速商品分类查询 |
| idx_status | status | 普通索引 | 加速商品状态查询 |
| idx_create_time | create_time | 普通索引 | 加速商品发布时间排序 |
| idx_price | price | 普通索引 | 加速商品价格排序 |

### 4.3 订单表（sh_order）

| 索引名 | 索引字段 | 索引类型 | 描述 |
| :--- | :--- | :--- | :--- |
| PRIMARY | order_id | 主键索引 | 唯一标识订单记录 |
| idx_order_no | order_no | 唯一索引 | 加速订单号查询，确保订单号唯一 |
| idx_user_id | user_id | 普通索引 | 加速用户订单查询 |
| idx_item_id | item_id | 普通索引 | 加速商品订单查询 |
| idx_status | status | 普通索引 | 加速订单状态查询 |
| idx_pay_status | pay_status | 普通索引 | 加速支付状态查询 |
| idx_create_time | create_time | 普通索引 | 加速订单创建时间排序 |

### 4.4 地址表（sh_address）

| 索引名 | 索引字段 | 索引类型 | 描述 |
| :--- | :--- | :--- | :--- |
| PRIMARY | address_id | 主键索引 | 唯一标识地址记录 |
| idx_user_id | user_id | 普通索引 | 加速用户地址查询 |
| idx_is_default | is_default | 普通索引 | 加速默认地址查询 |

### 4.5 收藏表（sh_favorite）

| 索引名 | 索引字段 | 索引类型 | 描述 |
| :--- | :--- | :--- | :--- |
| PRIMARY | favorite_id | 主键索引 | 唯一标识收藏记录 |
| idx_user_item | (user_id, item_id) | 唯一索引 | 防止重复收藏，加速用户收藏查询 |
| idx_user_id | user_id | 普通索引 | 加速用户收藏查询 |
| idx_item_id | item_id | 普通索引 | 加速商品收藏查询 |

### 4.6 留言表（sh_message）

| 索引名 | 索引字段 | 索引类型 | 描述 |
| :--- | :--- | :--- | :--- |
| PRIMARY | message_id | 主键索引 | 唯一标识留言记录 |
| idx_item_id | item_id | 普通索引 | 加速商品留言查询 |
| idx_user_id | user_id | 普通索引 | 加速用户留言查询 |
| idx_reply_id | reply_id | 普通索引 | 加速留言回复查询 |
| idx_create_time | create_time | 普通索引 | 加速留言时间排序 |

### 4.7 管理员表（sh_admin）

| 索引名 | 索引字段 | 索引类型 | 描述 |
| :--- | :--- | :--- | :--- |
| PRIMARY | admin_id | 主键索引 | 唯一标识管理员记录 |
| idx_username | username | 唯一索引 | 加速用户名查询，确保用户名唯一 |
| idx_status | status | 普通索引 | 加速管理员状态查询 |

### 4.8 订单地址表（sh_order_address）

| 索引名 | 索引字段 | 索引类型 | 描述 |
| :--- | :--- | :--- | :--- |
| PRIMARY | order_id | 主键索引 | 唯一标识订单地址记录 |

## 5. 存储过程设计

### 5.1 创建订单存储过程

```sql
DELIMITER //
CREATE PROCEDURE proc_create_order(IN p_user_id INT, IN p_item_id INT, OUT p_order_id INT, OUT p_order_no VARCHAR(32))
BEGIN
    DECLARE v_price DECIMAL(10,2);
    DECLARE v_item_status INT;
    DECLARE v_seller_id INT;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;
    
    START TRANSACTION;
    
    -- 检查商品状态
    SELECT status, price, user_id INTO v_item_status, v_price, v_seller_id FROM sh_idle_item WHERE item_id = p_item_id FOR UPDATE;
    
    -- 检查商品是否存在且可购买
    IF v_item_status IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '商品不存在';
    END IF;
    
    IF v_item_status != 1 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '商品已下架或已卖出';
    END IF;
    
    -- 检查是否是自己的商品
    IF v_seller_id = p_user_id THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '不能购买自己的商品';
    END IF;
    
    -- 生成订单号
    SET p_order_no = CONCAT(DATE_FORMAT(NOW(), '%Y%m%d%H%i%s'), LPAD(FLOOR(RAND() * 10000), 4, '0'));
    
    -- 创建订单
    INSERT INTO sh_order (order_no, user_id, item_id, price, pay_status, status) 
    VALUES (p_order_no, p_user_id, p_item_id, v_price, 0, 0);
    
    -- 获取订单ID
    SET p_order_id = LAST_INSERT_ID();
    
    -- 更新商品状态为已卖出
    UPDATE sh_idle_item SET status = 2 WHERE item_id = p_item_id;
    
    COMMIT;
END //
DELIMITER ;
```

### 5.2 支付订单存储过程

```sql
DELIMITER //
CREATE PROCEDURE proc_pay_order(IN p_order_id INT, IN p_pay_type INT)
BEGIN
    DECLARE v_order_status INT;
    DECLARE v_pay_status INT;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;
    
    START TRANSACTION;
    
    -- 检查订单状态
    SELECT status, pay_status INTO v_order_status, v_pay_status FROM sh_order WHERE order_id = p_order_id FOR UPDATE;
    
    IF v_order_status IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '订单不存在';
    END IF;
    
    IF v_order_status != 0 OR v_pay_status != 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '订单状态错误，无法支付';
    END IF;
    
    -- 更新订单支付状态
    UPDATE sh_order SET pay_status = 1, pay_type = p_pay_type, pay_time = NOW(), status = 1 WHERE order_id = p_order_id;
    
    COMMIT;
END //
DELIMITER ;
```

### 5.3 确认收货存储过程

```sql
DELIMITER //
CREATE PROCEDURE proc_confirm_order(IN p_order_id INT)
BEGIN
    DECLARE v_order_status INT;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;
    
    START TRANSACTION;
    
    -- 检查订单状态
    SELECT status INTO v_order_status FROM sh_order WHERE order_id = p_order_id FOR UPDATE;
    
    IF v_order_status IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '订单不存在';
    END IF;
    
    IF v_order_status != 1 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '订单状态错误，无法确认收货';
    END IF;
    
    -- 更新订单状态为已完成
    UPDATE sh_order SET status = 2 WHERE order_id = p_order_id;
    
    COMMIT;
END //
DELIMITER ;
```

### 5.4 取消订单存储过程

```sql
DELIMITER //
CREATE PROCEDURE proc_cancel_order(IN p_order_id INT)
BEGIN
    DECLARE v_order_status INT;
    DECLARE v_item_id INT;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;
    
    START TRANSACTION;
    
    -- 检查订单状态
    SELECT status, item_id INTO v_order_status, v_item_id FROM sh_order WHERE order_id = p_order_id FOR UPDATE;
    
    IF v_order_status IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '订单不存在';
    END IF;
    
    IF v_order_status NOT IN (0, 1) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '订单状态错误，无法取消';
    END IF;
    
    -- 更新订单状态为已取消
    UPDATE sh_order SET status = 3 WHERE order_id = p_order_id;
    
    -- 如果订单已支付，需要退款处理（这里简化处理）
    -- 更新商品状态为上架
    UPDATE sh_idle_item SET status = 1 WHERE item_id = v_item_id;
    
    COMMIT;
END //
DELIMITER ;
```

## 6. 触发器设计

### 6.1 订单地址触发器

```sql
DELIMITER //
CREATE TRIGGER trg_order_insert AFTER INSERT ON sh_order FOR EACH ROW
BEGIN
    DECLARE v_province VARCHAR(50);
    DECLARE v_city VARCHAR(50);
    DECLARE v_district VARCHAR(50);
    DECLARE v_detail_address VARCHAR(200);
    
    -- 获取用户默认地址
    SELECT province, city, district, detail_address INTO v_province, v_city, v_district, v_detail_address 
    FROM sh_address 
    WHERE user_id = NEW.user_id AND is_default = 1 
    LIMIT 1;
    
    -- 如果有默认地址，则创建订单地址记录
    IF v_province IS NOT NULL THEN
        INSERT INTO sh_order_address (order_id, province, city, district, detail_address)
        VALUES (NEW.order_id, v_province, v_city, v_district, v_detail_address);
    END IF;
END //
DELIMITER ;
```

### 6.2 商品状态更新触发器

```sql
DELIMITER //
CREATE TRIGGER trg_item_update BEFORE UPDATE ON sh_idle_item FOR EACH ROW
BEGIN
    -- 如果商品状态从非已卖出变为已卖出，检查是否有未完成的订单
    IF OLD.status != 2 AND NEW.status = 2 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '商品状态不能直接更新为已卖出，请通过创建订单流程操作';
    END IF;
    
    -- 如果商品状态从已卖出变为其他状态，检查是否有已完成的订单
    IF OLD.status = 2 AND NEW.status != 2 THEN
        DECLARE v_order_count INT;
        SELECT COUNT(*) INTO v_order_count FROM sh_order WHERE item_id = NEW.item_id AND status = 2;
        IF v_order_count > 0 THEN
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '商品已有已完成的订单，不能更改状态';
        END IF;
    END IF;
END //
DELIMITER ;
```

## 7. 视图设计

### 7.1 商品详情视图

```sql
CREATE VIEW v_item_detail AS
SELECT 
    i.item_id,
    i.user_id,
    i.item_name,
    i.price,
    i.description,
    i.images,
    i.category,
    i.address,
    i.create_time,
    i.status,
    u.nickname AS seller_nickname,
    u.avatar AS seller_avatar,
    COUNT(f.favorite_id) AS favorite_count,
    COUNT(m.message_id) AS message_count
FROM sh_idle_item i
LEFT JOIN sh_user u ON i.user_id = u.user_id
LEFT JOIN sh_favorite f ON i.item_id = f.item_id
LEFT JOIN sh_message m ON i.item_id = m.item_id AND m.status = 1
GROUP BY i.item_id;
```

### 7.2 订单详情视图

```sql
CREATE VIEW v_order_detail AS
SELECT 
    o.order_id,
    o.order_no,
    o.user_id AS buyer_id,
    o.item_id,
    o.price,
    o.pay_status,
    o.pay_type,
    o.create_time,
    o.pay_time,
    o.status,
    i.item_name,
    i.images,
    i.address AS trade_address,
    i.user_id AS seller_id,
    ub.nickname AS buyer_nickname,
    ub.avatar AS buyer_avatar,
    us.nickname AS seller_nickname,
    us.avatar AS seller_avatar,
    a.province,
    a.city,
    a.district,
    a.detail_address
FROM sh_order o
JOIN sh_idle_item i ON o.item_id = i.item_id
JOIN sh_user ub ON o.user_id = ub.user_id
JOIN sh_user us ON i.user_id = us.user_id
LEFT JOIN sh_order_address a ON o.order_id = a.order_id;
```

## 8. 数据库安全设计

### 8.1 用户权限管理

| 用户名 | 角色 | 权限 | 描述 |
| :--- | :--- | :--- | :--- |
| school_trade_app | 应用用户 | SELECT, INSERT, UPDATE, DELETE | 应用程序访问数据库的用户，具有基本的CRUD权限 |
| school_trade_read | 只读用户 | SELECT | 用于报表生成、数据分析等只读操作的用户 |
| school_trade_admin | 管理员用户 | ALL PRIVILEGES | 数据库管理员用户，具有所有权限 |

### 8.2 权限控制策略

1. **最小权限原则**：用户只授予完成工作所需的最小权限
2. **权限分离原则**：不同角色的用户授予不同的权限
3. **定期权限审查**：定期审查用户权限，确保权限分配合理
4. **密码策略**：强密码要求，定期更换密码
5. **SSL连接**：使用SSL加密数据库连接，防止数据在传输过程中被窃取

### 8.3 数据加密

1. **密码加密**：用户密码使用BCrypt算法加密存储
2. **敏感数据加密**：敏感数据（如手机号）可以考虑使用AES加密存储
3. **数据传输加密**：使用SSL/TLS加密数据库连接

## 9. 数据库备份与恢复策略

### 9.1 备份策略

| 备份类型 | 备份频率 | 备份方式 | 备份文件保留时间 |
| :--- | :--- | :--- | :--- |
| 完全备份 | 每天凌晨2:00 | mysqldump | 7天 |
| 增量备份 | 每小时 | binary log | 30天 |
| 差异备份 | 每周日凌晨2:00 | mysqldump | 30天 |

### 9.2 恢复策略

1. **完全恢复**：使用最新的完全备份文件恢复数据库
2. **点恢复**：使用完全备份文件和增量备份文件恢复到特定时间点
3. **恢复测试**：定期进行恢复测试，确保备份文件有效

### 9.3 备份命令示例

```bash
# 完全备份
mysqldump -u root -p --single-transaction --routines --triggers --events school_trade > school_trade_full_backup_$(date +%Y%m%d).sql

# 压缩备份
mysqldump -u root -p --single-transaction --routines --triggers --events school_trade | gzip > school_trade_full_backup_$(date +%Y%m%d).sql.gz
```

## 10. 性能优化考虑

### 10.1 索引优化

1. **选择合适的索引字段**：经常用于查询条件、排序和连接的字段
2. **避免过多索引**：索引会增加写入操作的开销
3. **使用联合索引**：根据查询模式创建联合索引，提高查询效率
4. **定期分析索引使用情况**：删除不使用的索引

### 10.2 查询优化

1. **避免全表扫描**：使用索引覆盖查询
2. **避免在WHERE子句中使用函数**：会导致索引失效
3. **使用LIMIT限制结果集**：减少数据传输量
4. **避免使用SELECT ***：只查询需要的字段
5. **使用JOIN替代子查询**：某些情况下JOIN更高效

### 10.3 表结构优化

1. **选择合适的数据类型**：使用最小的数据类型满足需求
2. **避免使用NULL**：NULL值会增加存储和查询开销
3. **使用INT代替字符串**：INT类型的查询和排序更高效
4. **使用ENUM代替字符串**：对于固定值的字段，使用ENUM更高效

### 10.4 服务器配置优化

1. **调整缓冲区大小**：如innodb_buffer_pool_size、key_buffer_size等
2. **调整连接数**：根据实际需求调整max_connections
3. **启用查询缓存**：对于读多写少的应用
4. **使用分区表**：对于大表，使用分区表提高查询效率

## 11. 总结

本数据库设计文档详细描述了校园二手交易平台的数据库设计，包括数据库表结构、索引设计、存储过程、触发器、视图等内容。设计遵循了数据完整性、安全性、性能优化等原则，确保了数据库的可靠性和高效性。

本设计文档为数据库开发、维护和优化提供了详细的指导，同时也为应用程序开发提供了清晰的数据模型参考。